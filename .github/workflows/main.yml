name: Update Deployment

on:
  repository_dispatch:
    types: [update-deployment]
jobs:
  update-image-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Get latest Docker image tag
        run: |
          IMAGE_TAG=$(curl -s -S "https://registry.hub.docker.com/v2/repositories/rayahh/3tier-front/tags/" | jq '."results"[]["name"]' | sed -n 1p | sed -e "s/^.//;s/.$//")
          echo "::set-output name=image_tag::$IMAGE_TAG"
      - name: Update image tag in deployment manifest
        id: update_manifest
        uses: appleboy/replace-string@master
        with:
          file: 'k8s/client-deployment.yml'
          find: 'rayahh/3tier-front:.*'
          replace: 'rayahh/3tier-front:${{ steps.get_tag.outputs.image_tag }}'
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add k8s/client-deployment.yml
          git commit -m "Update image tag to ${{ steps.get_tag.outputs.image_tag }}"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
